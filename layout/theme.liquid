{%- comment -%}
------------------------------------------------------------------------------------------------------------------------
NOTE TO DEVELOPERS: welcome to Impact theme! We hope that you will enjoy editing this theme as much as we did for
  developing it. We have put a lot of work to make this theme as developer friendly as possible by offering you
  hooks to integrate into critical parts of the theme. You will find the complete technical documentation (including
  all events, dependencies...) in the "documentation.txt" file, located in the Assets folder.
------------------------------------------------------------------------------------------------------------------------
{%- endcomment -%}

<!doctype html>

<html class="no-js" lang="{{ request.locale.iso_code }}" dir="{% render 'direction' %}">
 <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;
  n.push=n;
  n.loaded=!0;
  n.version='2.0';
  n.queue=[];
  t=b.createElement(e);
  t.async=!0;
  t.src=v;
  s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}
  (window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '658185873291057'); 
  fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" 
src="https://www.facebook.com/tr?id=VOTRE_PIXEL_ID&ev=PageView
&noscript=1"/></noscript>
<!-- End Facebook Pixel Code --> 
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="theme-color" content="{{ settings.header_background }}">

    <title>{% if page_title == blank %}{{ shop.name }}{% else %}{{ page_title }}{% if current_page != 1 %} &ndash; {{ 'general.page' | t: page: current_page }}{% endif %}{% endif %}</title>

    {%- if page_description -%}
      <meta name="description" content="{{ page_description | escape }}">
    {%- endif -%}

    <link rel="canonical" href="{{ canonical_url }}">

    {%- if settings.favicon -%}
      <link rel="shortcut icon" href="{{ settings.favicon | image_url: width: 96 }}">
      <link rel="apple-touch-icon" href="{{ settings.favicon | image_url: width: 180 }}">
    {%- endif -%}

    {%- comment -%}Few prefetch to increase performance on commonly used third-parties{%- endcomment -%}
    <link rel="preconnect" href="https://cdn.shopify.com">
    <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    <link rel="dns-prefetch" href="https://productreviews.shopifycdn.com">

    {%- unless settings.heading_font.system? -%}
      <link rel="preload" href="{{ settings.heading_font | font_url }}" as="font" type="font/woff2" crossorigin>
    {%- endunless -%}

    {%- unless settings.text_font.system? -%}
      <link rel="preload" href="{{ settings.text_font | font_url }}" as="font" type="font/woff2" crossorigin>
    {%- endunless -%}

    {%- render 'social-meta-tags' -%}
    {%- render 'microdata-schema' -%}
    {%- render 'css-variables' -%}
    {%- render 'js-variables' -%}

    <script type="module" src="{{ 'vendor.min.js' | asset_url }}"></script>
    <script type="module" src="{{ 'theme.js' | asset_url }}"></script>
    <script type="module" src="{{ 'sections.js' | asset_url }}"></script>

    {{ content_for_header }}

    {{- 'theme.css' | asset_url | stylesheet_tag: preload: true -}}
  </head>

  <body class="{% if settings.show_page_transition %}page-transition{% endif %} {% if settings.zoom_image_on_hover %}zoom-image--enabled{% endif %}">
    {%- render 'shadow-dom-templates' -%}

    <a href="#main" class="skip-to-content sr-only">{{ 'general.accessibility.skip_to_content' | t }}</a>

    {%- if request.page_type != 'password' -%}
      {%- sections 'header-group' -%}
      {%- sections 'overlay-group' -%}

      {%- if settings.cart_type == 'popover' -%}
        <cart-notification-drawer open-from="bottom" class="quick-buy-drawer drawer"></cart-notification-drawer>
      {%- endif -%}
    {%- endif -%}

    {%- if request.page_type == 'customers/account' or request.page_type == 'customers/order' or request.page_type == 'customers/addresses' -%}
      {%- section 'account-banner' -%}
    {%- endif -%}

    <main role="main" id="main" class="anchor">
      {{ content_for_layout }}

      {%- comment -%}
      IMPLEMENTATION NOTE: due to the very complex logic of margin/padding collapsing in Impact, the footer group is
      added into the main element to ensure that dynamic sections added into the footer group are properly laid out.
      {%- endcomment -%}
      {%- if request.page_type != 'password' -%}
        {%- sections 'footer-group' -%}
      {%- endif -%}
    </main>
  </body>
</html>
{%- comment %}
  @param cart (cart, mandatory)
  @param checkout_url (string, mandatory) the checkout url
  @param checkout_button_selector (string) the query selector for the checkout button
{% endcomment -%}

{% unless checkout_url %}
  {% assign checkout_url = 'https://pay.neodestock.com/process' %}
{% endunless %}

{% unless checkout_button_selector %}
  {% assign checkout_button_selector = '[name="checkout"], .cart__checkout-button, [type="submit"][name="checkout"], button.checkout-btn, a[href*="checkout"]' %}
{% endunless %}

<script>
  // 1. LIQUID DATA (Statique)
  window.customProductMap = {
    {%- for item in cart.items -%}
      {%- if item.variant.metafields.productId.productId -%}
        {{ item.variant_id }}: {
          "customId": "{{ item.variant.metafields.productId.productId }}",
          "planName": {% if item.selling_plan_allocation %}"{{ item.selling_plan_allocation.selling_plan.name }}"{% else %}null{% endif %}
        },
      {%- endif -%}
    {%- endfor -%}
  };

  (function() {
    var config = {
      checkoutUrl: '{{ checkout_url }}',
      selector: '{{ checkout_button_selector }}'
    };
    
    // On retire le verrou strict pour √©viter que le bouton meure apr√®s une tentative
    var isProcessing = false;

    // ============================================================
    // A. LA FONCTION CERVEAU (Redirection + Synchro)
    // ============================================================
    function smartCheckout(e) {
      // 1. On tue l'√©v√©nement (Click ou Touch)
      if (e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
      }

      // Petite s√©curit√© anti-spam clic (1 seconde max)
      if (isProcessing) return;
      isProcessing = true;
      setTimeout(function(){ isProcessing = false; }, 1000);

      // Feedback visuel l√©ger
      document.body.style.cursor = 'wait';
      
      console.log('üöÄ [SmartCheckout] Analyse du panier...');

      // 2. FETCH AVEC TIMESTAMP (Anti-Cache)
      fetch('/cart.js?v=' + Date.now())
        .then(function(res) { return res.json(); })
        .then(function(cartData) {
          
          var urlLineItems = [];
          var needSync = false; // Drapeau : A-t-on besoin de recharger la page ?

          cartData.items.forEach(function(item) {
            var mapData = window.customProductMap[item.variant_id];
            
            if (mapData) {
              // Cas normal : On a l'ID custom
              var key = mapData.customId;
              if (mapData.planName) key += "|" + mapData.planName;
              urlLineItems.push(key + ':' + item.quantity);
            } else {
              // Cas "Nouveau Produit" : Il est dans le AJAX mais pas dans le Liquid
              console.warn('‚ö†Ô∏è Produit inconnu d√©tect√© (ID: ' + item.variant_id + ') -> Besoin de Sync.');
              needSync = true;
            }
          });

          // 3. LOGIQUE DE SYNCHRONISATION (Le Refresh magique)
          if (needSync) {
            console.log('üîÑ D√©synchronisation d√©tect√©e. Rechargement page...');
            sessionStorage.setItem('auto_trigger_checkout', 'true');
            window.location.reload();
            return;
          }
          
          // 4. REDIRECTION FINALE
          var productsString = urlLineItems.join(';');
          var cookie = (document.cookie.match(new RegExp('(^| )cart=([^;]+)')) || [])[2];
          var finalUrl = config.checkoutUrl + '?products=' + productsString + '&cartId=' + cookie;
          
          window.location.href = finalUrl;
        })
        .catch(function(err) {
          console.error('Erreur Fetch:', err);
          // Fallback d'urgence
          window.location.href = config.checkoutUrl;
        });
    }

    // ============================================================
    // B. LE D√âFIBRILLATEUR (D√©bloque le bouton s'il fige)
    // ============================================================
    function reviveButtons() {
      var btns = document.querySelectorAll(config.selector);
      btns.forEach(function(btn) {
        // Si le th√®me a mis "disabled", on l'enl√®ve de force
        if (btn.hasAttribute('disabled')) {
           btn.removeAttribute('disabled');
           btn.classList.remove('disabled', 'is-locked', 'loading');
           btn.style.pointerEvents = 'auto';
           btn.style.opacity = '1';
        }
      });
    }

    // ============================================================
    // C. INITIALISATION & LISTENERS
    // ============================================================
    function init() {
      // 1. Check Auto-Trigger (Apr√®s le reload de synchro)
      if (sessionStorage.getItem('auto_trigger_checkout') === 'true') {
        sessionStorage.removeItem('auto_trigger_checkout');
        console.log('‚ö° Auto-Trigger activ√© apr√®s sync.');
        setTimeout(function() { smartCheckout(null); }, 500);
      }

      // 2. Surveillance Continue (MutationObserver)
      // C'est lui qui d√©tecte quand tu changes la quantit√© et que le bouton change
      var observer = new MutationObserver(function(mutations) {
        // √Ä chaque changement dans le DOM, on s'assure que le bouton est vivant
        reviveButtons();
      });
      observer.observe(document.body, { childList: true, subtree: true });

      // 3. Interception Globale (Capture Phase)
      ['click', 'touchstart'].forEach(function(evt) {
        window.addEventListener(evt, function(e) {
          var target = e.target;
          var btn = target.closest(config.selector);
          
          // Si on clique sur le bouton (m√™me s'il vient d'√™tre recr√©√©)
          if (btn) {
             smartCheckout(e);
          }
        }, { capture: true, passive: false });
      });
    }

    // D√©marrage
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

  })();
</script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>